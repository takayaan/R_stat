---
title: "Rと統計勉強会 第3回"
author: "Hisamitsu Takaya"
date: "2018/7/20"
output: 
  html_document:
    toc: yes
    toc_depth: 3
---

# Rと統計の勉強会　第3回

<br>

## 確率の基礎

<br>

### 確率とは

<br>
コインの表裏が出る確率は？

サイコロのそれぞれの目の出る確率は？

確率を確かめるにはどうすればいい？

Rで試してみよう。

```{r}
# コイントスの関数を作る
coin_toss <- function(x){
  coin <- c("表","裏")
  res <- c()
  for(i in 1:x){
    res[i] <- sample(coin,1)
  }
  return(res)
}
```

確率を推測するにはどうすればいいか。

```{r}
# "表""裏"の数を数える
val <- ifelse(coin_toss(100)=="表",1,0)
sum(val)
# 全体の数で割る
sum(val)/100
```

試行回数を増やせば増やすほど表の出る割合は真の値に近づくはず。

```{r}
n <- 10^5
val <- ifelse(coin_toss(n)=="表",1,0)
sum(val)
sum(val)/n

# 確率の推移をグラフ化する
cumval <- cumsum(val)
plot(seq(1,n),cumval/seq(1,n),ylim=c(0,1),type="l")
```

これを<u>頻度論による確率</u>という。
<br>
では確率の定義を一般化してみよう。

起こりうるすべての事象$\Omega$に対し、同様に確からしく起こる有限個の事象$A$が起こる確率は、

<br>
（$A$の要素の個数）/（$\Omega$の要素の個数）＝$P(A)$

<br>
$P$は$\Omega$における（確率を返す）関数ということができる。

<br>

- 歪みのないコインを1回振って表の出る確率
  - $A:\{$表$\}$、$\Omega:\{$表、裏$\}$
- 立方体のサイコロを1回振って、目が偶数の確率
  - $A:\{2,4,6\}$、$\Omega:\{1,2,3,4,5,6\}$

<br>
**確率の性質**

- すべての事象$A$に対し、$0\leq P(A)\leq 1$
- $P(\Omega)=1$
- 互いに排反な事象$A_i,A_j(i\neq j)$について、$P(A_i\cup A_j)=P(A_i)+P(A_j)$

<br>
<br>
$\Omega$を地球上（宇宙でも良い）のある1点の集合とし、$\Omega$を形成するそれぞれの点を$\omega_i$と考える。便宜上、$\Omega$の面積を1と考えよう。ある試行に対して$A$が起こる確率$P(A)$は、それぞれの全ての$\omega$について、$A$が起きた$\omega$の面積と言い換えることができる。

<br>
例えばコイントスを考えると、$\omega_{\text{裏}}=\bigcup_{\omega_i \in \text{裏}}\omega_i,\ \omega_{\text{表}}=\bigcup_{\omega_i \in \text{表}}\omega_i(i=1,2,3,...)$とすると$P(\omega_{\text{表}})$が表の出る確率となる。この確率とは、$\Omega$の立場から$\omega_i$を見渡すことできれば、それぞれの$\omega_i$が$\omega_{\text{裏}}$なのか$\omega_{\text{表}}$なのかは確定的な事実であり、確率はそれぞれの面積を測れば良い。言い換えると、全地球を見渡すことのできる誰か（便宜上神様としておく）の視点で眺めてみると、それぞれの$\omega_i$で表となるか裏となるかは確定の事実である。だが、$\omega_i$上にいる誰かがコインを振るとき、それが表が出るか裏が出るかは確率$P(\omega_{\text{裏,表}})$によって変動する。

<br>

### 確率変数

<br>
確率によって揺らぐ値。値に対して値が出現する確率が与えられている変数。

- コインの表＝1、コインの裏＝0とすると、$\{0,1\}$は確率変数
- サイコロを2回振った時の出た目の和$X=\{2,3,...,12\}$は確率変数

<br>
先ほどの確率で話をしたコイントスの$\Omega$を考える。試行の結果の事象、つまりコインの$\omega_{\text{裏}}$と$\omega_{\text{表}}$が$\Omega$を構成する要素である。それぞれの要素には確率を返す関数$P$が存在するが、これは$\Omega$上の関数である。

<br>
コインの裏表に対して、ある実数値$\{a,b\}$を与えるとすると、それは実数空間で存在しているのであって、関数$P$で確率を返すことはできない。つまり、$\omega_{\text{裏}}\to a,\ \ \omega_{\text{表}}\to b$となるような関数$X$を考えると、$P(X=a)=P(\omega_{\text{裏}})$となり、確率を返すことが可能になる。この関数$X$が確率変数である。

<br>
上記の例でいうと、

- 確率変数$X$はコインの裏表に従って整数値$\{0,1\}$を返す関数
- 確率変数$X$はサイコロ2回の目に従って、その和を返す関数

となる。

<br>

### 確率分布

<br>
ある確率変数$X=x$に対して、その起こりやすさ＝確率は$P(X=x)$として書くことができる。

仮に、確率変数$X$が可算有限個の集合$\{x_1,x_2,...,x_n\}$とすると、それぞれに確率$p_k=P(X=x_k)$が与えられ、これは$X$に対する関数である。この関数を<u>確率分布</u>と言う。確率分布は確率変数$X=x_k$を与えると確率$p_k$を返す関数$f(x_k)$と考えることができるので、確率関数ということができる。

<br>
確率関数の性質は、

- $f(x_k)\geq 0$
- $\sum_k{f(x_k)}=1$

<br>
例）サイコロを2回振った時の出た目の和$X$の確率分布

```{r}
# 36行×2列の行列を作る
a <- matrix(0,36,2)
# カウント変数を設定する
r <- 1
# サイコロの出目の組み合わせを総当たりで行列に格納する
for (i in 1:6){
  for (j in 1:6){
    a[r,] <- c(i,j)
    r <- r + 1
  }
}
# 出目の和をとる
b <- a[,1]+a[,2]
# 数字をカウントする
tabulate(b)
# それぞれの確率を計算する
p <- tabulate(b)/36
# プロットする
plot(1:12,p,type="h")
```

確率変数$X$が連続値である場合、確率はある区間の範囲の確率をいう（ある1点での確率は0になる）。つまり、確率変数$X$が任意の区間$a\leq X\leq b$をとる場合の確率$P(a\leq X\leq b)=\int_a^b f(x)dx$として表される。この時の$f(x)$を<u>確率密度関数</u>という。

また、$X$がある任意の値$x$までの値をとる場合の確率は、$P(X\leq x)$で表される。この確率を$x$の関数として表した場合、$F(x)=P(X\leq x)$を<u>累積分布関数</u>という。

<br>

### 代表的な確率分布

<br>

#### 二項分布（離散値確率分布）

<br>
1回の試行（ベルヌーイ試行）につき確率$p(0\leq p \leq 1)$で起こる事象を考える。例えばコイントスのようなものである。

歪みのないコインを5回振る試行を考える。全ての裏、表の組み合わせは$2^5=32$通りである。ここで、表が3回でる事象を考えると、組み合わせは${}_5 C_3=10$通りになるので、確率は$\frac{10}{32}$となる。

表が$0,1,2,3,4,5$回の確率$p(i)(i=0,1,2,3,4,5)$はそれぞれ、
$$
\begin{align}
p(0)&={}_5 C_0/2^5=1/32\\
p(1)&={}_5 C_1/2^5=5/32\\
p(2)&={}_5 C_2/2^5=10/32\\
p(3)&={}_5 C_3/2^5=10/32\\
p(4)&={}_5 C_4/2^5=5/32\\
p(5)&={}_5 C_5/2^5=1/32
\end{align}
$$
となる。

<br>
Rでグラフ化する

```{r}
p <- c()
p[1] <- choose(5,0)/(2^5)
p[2] <- choose(5,1)/(2^5)
p[3] <- choose(5,2)/(2^5)
p[4] <- choose(5,3)/(2^5)
p[5] <- choose(5,4)/(2^5)
p[6] <- choose(5,5)/(2^5)
plot(1:6,p,type="h")
```

ここで、確率$p(i)$は、
$$
p(i)={}_5 C_i \left(\frac{1}{2}\right)^5
$$
と書ける。コインの表裏が同じ確率であれば上記の式で確率は求められるが、歪みがある場合、例えば表が出る確率が$0.3$とすると確率はどうなるだろうか。

例として、表が5回中3回出る確率を求めると、
$$
p(3)={}_5 C_3(0.3)^3(1-0.3)^2=0.1323
$$
となる。先と同様、Rでグラフ化する。

```{r}
p <- c()
p[1] <- choose(5,0)*(0.3)^0*(1-0.3)^5
p[2] <- choose(5,1)*(0.3)^1*(1-0.3)^4
p[3] <- choose(5,2)*(0.3)^2*(1-0.3)^3
p[4] <- choose(5,3)*(0.3)^3*(1-0.3)^2
p[5] <- choose(5,4)*(0.3)^4*(1-0.3)^1
p[6] <- choose(5,5)*(0.3)^5*(1-0.3)^0
plot(1:6,p,col="red",type="h")
```

先ほどとは異なるグラフになる。

これを試行回数を増やすとグラフの形はどうなるだろうか。

```{r}
binom <- function(x,p){
    f <- c()
    for(i in 1:(x+1)){
        f[i] <- choose(x,(i-1))*(p^(i-1))*((1-p)^(x-i+1))
    }
    plot(1:(x+1),f,type="h")
}
```

`x`に総試行回数、`p`に確率を入れると確率のグラフを返してくれる関数を作成した。`x`と`p`の値を色々と変えてやることでグラフの動きが確認できる。

これが二項分布である。

<br>
一般化すると、確率$p$である事象が起こる試行を$n$回行なった時に事象が生じた回数を$x$とすると、$X=x$の確率は、
$$
P(X=x)={}_n C_xp^x(1-p)^{n-x}
$$
となり、Rには元から関数として組み込まれている。

- `dbinom(x,n,p)`：1回の試行につき確率$p$で起こる事象が、$n$回の試行で$x$回起こる確率
- `pbinom(q,n,p)`：1回の試行につき確率$p$で起こる事象が、$n$回の試行で$q$回以下起こる確率（累積確率）
- `qbinom(prob,n,p)`：1回の試行につき確率$p$で起こる事象が、$n$回の試行で累積確率$\mathrm{prob}$で起こるために必要な事象の回数（クォンタイル値）
- `rbinom(r,n,p)`：試行回数$n$、確率$p$の二項分布に従う乱数を$r$個発生させる。

<br>  

#### 正規分布（連続値確率分布）

<br>
正規分布とは何ぞや？

- 左右対称
- 平均まわりで確率が高くなる
- 平均から遠ざかると確率が0に近くなる
- 平均と分散で分布の形が決まる

<br>
なぜ正規分布が持て囃されるのか。

- おおよそ多くの統計データは正規分布の形をとる
- 正規分布を元に標本分布が定められていることが多い
- **中心極限定理**

<br>
正規分布で最も標準的な形が、標準正規分布である。

<br>
標準正規分布の確率密度関数
$$
f(x)=\frac{1}{\sqrt{2 \pi}}\exp \left(-\frac{x^2}{2}\right)dx
$$
ややこしいので$\frac{1}{\sqrt{2 \pi}}$と$\exp(-\frac{x^2}{2})$に分けて考える。

<br>
$f(x)=\exp(-\frac{x^2}{2})$はどのようなグラフだろう。

- $f(a)=f(-a)$
- $x \to -\infty, \infty$の時、$-\frac{x^2}{2} \to 0$なので$f(x) \to 0$
- $x=0$で最大値$1$をとる

<br>
実際にRで描いてみよう。

```{r}
curve(exp(-(x^2)/2),xlim=c(-5,5))
```

いわゆる正規分布の形になる。

<br>
では$\frac{1}{\sqrt{2 \pi}}$はなんだろうか。

確率密度関数の性質は、
$$
\int_{-\infty}^{\infty}f(x)dx=1
$$
ここで、
$$
\int_{-\infty}^{\infty}\exp \left(-\frac{x^2}{2}\right)dx=\sqrt{2 \pi}
$$
なので、$\frac{1}{\sqrt{2 \pi}}$は積分して1にするための単なる定数と考えれば良い。
これが、標準正規分布であり、平均（期待値）は0、分散は1である。
一般化して、平均$\mu$、分散$\sigma^2$の正規分布の確率密度関数は、
$$
f(x)=\frac{1}{\sqrt{2 \pi \sigma^2}}\exp \left(-\frac{(x-\mu)^2}{2\sigma^2}\right)
$$
となる（覚える必要なし）。大事なのは、平均と分散が決まれば分布の形が決まるということ。

```{r}
#標準正規分布
curve(dnorm(x,0,1),xlim=c(-10,10),ylim=c(0,0.5))
#平均を変えると形はどうなるか
curve(dnorm(x,1,1),xlim=c(-10,10),ylim=c(0,0.5),col="red",add=T)
#分散を変えると形はどうなるか
curve(dnorm(x,0,2),xlim=c(-10,10),ylim=c(0,0.5),col="blue",add=T)
```

Rでの正規分布関数（`m`：平均、`sd`：標準偏差）

- `dnorm(x,m,sd)`：$\Delta x$の確率密度を返す
- `pnorm(q,m,sd)`：$F(q)=P(X\leq q)$を返す
- `qnorm(p,m,sd)`：累積確率$p$を与えた時のクォンタイル値を返す
- `rnorm(n,m,sd)`：正規分布に従う乱数を$n$個返す

<br>  

#### 二項分布の正規近似

<br>
確率変数$X$が$\mathrm{Bin}(n,p)$に従うとき、$n$が十分に大きい場合、$X\approx N(np,\sqrt{np(1-p)})$

言い換えると、確率変数$X$が$\mathrm{Bin}(n,p)$に従うとき、$n$が十分に大きい場合、$\frac{X-np}{\sqrt{np(1-p)}}$は標準正規分布に従う

```{r}
#二項分布で作った関数に少し手を加える
binom <- function(x,p){
    f <- c()
    for(i in 1:(x+1)){
        f[i] <- choose(x,(i))*(p^(i))*((1-p)^(x-i))
    }
    plot(1:(x+1),f,type="h")
}
binom(10,0.5)
binom(30,0.5)
binom(100,0.5)
#正規分布のグラフと重ねて見る
curve(dnorm(x,100*0.5,sqrt(100*0.5*0.5)),add=T,col="red")
```

これは、確率変数$X_i(i=1,2,3,\cdots)$が$\mathrm{Bin}(1,p)$に従い互いに$\mathrm{i.i.d.}$である時、確率変数の和$X=\sum_i{X_i}$は正規分布に近似されると言える。

<br>
これを拡張して、確率変数$X_i(i=1,2,3,\cdots)$が互いに$\mathrm{i.i.d.}$である場合、$X_i$の分布によらず確率変数の和$X=\sum_i{X_i}$は正規分布に近似される。これを<u>中心極限定理</u>という。
