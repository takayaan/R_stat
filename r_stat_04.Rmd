---
title: "Rと統計勉強会 第4回"
author: "Hisamitsu Takaya"
date: "2018/7/23"
output: 
  html_document:
    toc: yes
    toc_depth: 3
---

# Rと統計の勉強会　第4回  
<br>

## 統計的仮説検定入門  
<br>

### 統計的仮説検定の手順  
<br>

1. 帰無仮説$(H_0)$を立てる
1. 対立仮説$(H_A$または$H_1)$を立てる
1. $H_0$のもとで標本統計量（検定統計量）の分布を明らかにする
1. 有意水準$\alpha$から棄却域を設定する
1. データから検定統計量を計算し、統計量が棄却域に入る場合は帰無仮説を棄却する  

<br>例で考えて見ましょう。

<br>
**例1）コインを10回投げたら表が3回出た。このコインは歪みがないと言えるだろうか。**  

<br>
*知りたいことは？*

$\to$コインに歪みがあるかどうか。

*歪みがないとはどういうことか？*

$\to$表が出る確率＝裏が出る確率

つまり、表が出る確率を$p$とすると、$p=0.5$であることが歪みのないコインであるということ。

<br>
もう一度最初の問いに戻ると、

*知りたいことは？*

$\to$$p=0.5$かどうか

*この時、帰無仮説としては$p=0.5$か$p\neq 0.5$かどちらが良いか。*

$\to$帰無仮説のもとで分布を考えるので、$p=0.5$で考えるべき

$\to$**帰無仮説：$p=0.5$**

*帰無仮説が決まれば対立仮説が決まる*

$\to$**対立仮説：$p\neq 0.5$**

帰無仮説のもとで、**検定統計量は$Bi(10,0.5)$に従う**  

<br>
$Bi(10,0.5)$の$P(X=i)(i=0,1,\cdots,10)$と$P(X\leq i)$をグラフ化する

```{r}
x <- seq(0,10)
d <- dbinom(x,10,0.5)
plot(x,d,pch=16,ylim=c(0,1))

p <- pbinom(x,10,0.5)
# par(new=T)
plot(x,p,pch=16,col=2,ylim=c(0,1))
```

コインを10回投げて3回表が出た場合、$P(X\leq 3)< \alpha$なら帰無仮説を棄却する。

仮に$\alpha=0.05$とすると、この$P(X\leq 3)$がいわゆる$p$値となる。

```{r}
pbinom(3,10,0.5)
```

$P(X\leq 3)=0.1718>\alpha$なので帰無仮説は棄却されない。

よって、統計的仮説検定ではコインは歪んでいるとは言えない、と判断される。  

<br>
**例2) ある工場では100gの製品を作る機械があるが、誤差が平均0、分散2の正規分布をとるとわかっている。製品を10個作ったところ、重さが102.8  99.6  98.9 103.2 100.1  93.8 104.0  94.8  96.3  96.7(g)だった。平均は100gといえるだろうか。**  

<br>
*知りたいことは？*

$\to$平均が100gかどうか

$\to$帰無仮説：平均＝100

*帰無仮説が決まれば対立仮説が決まる*

$\to$対立仮説：平均$\neq$100

帰無仮説のもとで、検定統計量＝標本平均は$N(100,2/10)$に従う。  

<br>
$N(100,2/10)$を図示してみる

```{r}
curve(dnorm(x,100,sqrt(2/10)),xlim=c(93,107))
# サンプルデータと標本平均を重ねる
s <- c(102.8, 99.6, 98.9, 103.2, 100.1, 93.8, 104.0, 94.8, 96.3, 96.7)
m <- mean(s)
sy0 <- rep(0,10)
sy1 <- rep(0.025,10)
segments(s,sy0,s,sy1)
abline(v=m,col=2)
```

$\alpha=0.05$として両側検定を行う

棄却域を図示する

```{r}
x.l <- seq(93,qnorm(0.025,100,sqrt(2/10)),by=0.01)
x.u <- seq(qnorm(0.975,100,sqrt(2/10)),107,by=0.01)
curve(dnorm(x,100,sqrt(2/10)),xlim=c(93,107))
polygon(c(x.l,rev(x.l)),c(rep(0,length(x.l)),dnorm(rev(x.l),100,sqrt(2/10))),col=2)
polygon(c(x.u,rev(x.u)),c(rep(0,length(x.u)),dnorm(rev(x.u),100,sqrt(2/10))),col=2)
abline(v=m,col=2)
```

棄却域に標本平均の線が入っているので、帰無仮説は棄却されるはずである。  

```{r}
# p値
pnorm(m,100,sqrt(2/10))
```
<br>

### p値  

<br>
p値は統計量の従う分布の下側確率

確率密度関数の曲線下面積は1なので、p値のとる範囲は$0\leq p\leq1$

有意水準＞p値で帰無仮説を棄却する

ではp値の分布は？

```{r}
# 帰無仮説が正しい場合の検定を10000回行いp値の分布を見る
N <- 10^4
p <- numeric(N)

# 平均100、分散25の母集団から100個サンプリングする
for(i in 1:N){
  d <- rnorm(100,100,5)
  m <- mean(d)
  # 標本平均のp値を計算し、格納する
  p[i] <- pnorm(m,100,5/10)
}

hist(p,breaks=seq(0,1,length=40))
```

帰無仮説が正しい場合、p値は一様分布となる

<br>
では帰無仮説が正しくない場合はどうなるか

```{r}
# 平均99、分散25の母集団から100個サンプリングして平均100として検定する
for(i in 1:N){
  d <- rnorm(100,99,5)
  m <- mean(d)
  p[i] <- pnorm(m,100,5/10)
}

hist(p,breaks=seq(0,1,length=40))
```

p値が小さい値をとる頻度が多くなる  

<br>

### 有意水準と検定力  

<br>
有意水準を決めると棄却域が決まる

棄却域が決まれば帰無仮説を棄却することができる

帰無仮説(＝p値が一様分布となる)のもとで、帰無仮説を棄却するためのp値の閾値を決める

<br>
**有名な表**

|                        | 帰無仮説を棄却                     | 帰無仮説を棄却しない              |
| ---------------------- | ---------------------------------- | --------------------------------- |
| **真実＝帰無仮説は真** | 間違い(第1種の過誤$=\alpha$エラー) | 正しい判断                        |
| **真実＝帰無仮説は偽** | 正しい判断                         | 間違い(第2種の過誤$=\beta$エラー) |

<br>
本当は帰無仮説が真なら帰無仮説を棄却したくないし、帰無仮説が偽なら帰無仮説を棄却したい

でも真実は人間ごとき存在が知りようもないので、人間は何かしらの基準をもとに帰無仮説を棄却する・しないという判断をする他ない

$\alpha=0.05$に設定するということは、真実が「帰無仮説は真」であっても、帰無仮説に従う分布の中でとり得る確率が$95\%$から外れる値は、真実と捉えなくても大きな問題はないだろう、ということ  

<br>
ではこの棄却域を対立仮説の立場からみればどうなるか

対立仮説が真＝帰無仮説が偽の時は、帰無仮説を棄却して欲しい

真実が「帰無仮説は偽」であるときに帰無仮説を棄却する確率が検定力

これは、対立仮説に従う分布の中で、帰無仮説の棄却域に入ってに帰無仮説が棄却される値域の確率のこと  

<br>
図示してみる

```{r}
# 母平均（未知）100、母分散（既知）40の集団から10個サンプリングして値の平均をとると105だった
# 帰無仮説と対立仮説の分布を描く
m.n <- 100
m.a <- 105
sd <- sqrt(40)
n <- 10
se <- sd/sqrt(n) # 標準誤差＝標準偏差/sqrt(サンプル数）

curve(dnorm(x,m.n,se),xlim=c(90,115))
curve(dnorm(x,m.a,se),xlim=c(90,115),col=2,add=T)

# 有意水準＝0.05（両側検定）として、棄却域と検出力を描く
polygon(c(seq(qnorm(0.975,m.n,se),115,length=100),seq(115,qnorm(0.975,m.n,se),length=100)),c(rep(0,100),dnorm(seq(115,qnorm(0.975,m.n,se),length=100),m.a,se)),col="#00ffff4C")
polygon(c(seq(qnorm(0.975,m.n,se),110,length=100),seq(110,qnorm(0.975,m.n,se),length=100)),c(rep(0,100),dnorm(seq(110,qnorm(0.975,m.n,se),length=100),m.n,se)),col=1,density=40)
polygon(c(seq(95,qnorm(0.975,m.n,se),length=100),seq(qnorm(0.975,m.n,se),95,length=100)),c(rep(0,100),dnorm(seq(qnorm(0.975,m.n,se),95,length=100),m.a,se)),col=2,density=40)

text(x=101,y=0.05,col=2,labels=expression(beta))
text(x=105,y=0.03,col=1,labels=expression(alpha/2))
text(x=105.5,y=0.10,col=4,labels=expression(1-beta))
segments(104.5,0.01,104.8,0.02)
abline(v=qnorm(0.975,m.n,se),col=3)
```

この場合、検定力はサンプル数によって大きく変わることがわかる  

<br>
実際に図示してみる

```{r}
# サンプル数をN=10,20,30,40,50,100,200,400でシミュレーション
N <- c(10,20,30,40,50,100,200,400)
# 対立仮説の平均を90~110まで0.1刻みで設定
MA <- seq(90,110,by=0.1)
labels <- NULL
for(i in 1:length(N)){
  pow <- NULL
  for(j in 1:length(MA)){
    SE <- sd/sqrt(N[i])
    # 対立仮説の平均＞帰無仮説の平均の場合は対立仮説の分布の上側確率、逆の場合は対立仮説の分布の下側確率が検定力となる
    if(MA[j]>=m.n){
      pow <- c(pow,pnorm(qnorm(0.975,m.n,SE),MA[j],SE,lower.tail=F))
    }else{
      pow <- c(pow,pnorm(qnorm(0.025,m.n,SE),MA[j],SE,lower.tail=T))
    }
  }
  labels <- c(labels,paste("N=",N[i]))
  plot(MA,pow,type="l",col=i,lty=i,ylim=c(0,1),xlim=c(min(MA),max(MA)))
  par(new=T)
}
par(new=F)
legend("bottomright",legend=labels,col=1:length(N),lty=1:length(N))
```

このように、サンプル数の設定は検定力を設定することで定めることができる。